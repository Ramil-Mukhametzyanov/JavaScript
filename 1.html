<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
.a_red:hover{
	color: #FFAAAA;
	background-color: #990000;
}
.b_red {
	color: #FF0000;
}
.a_orange:hover{
	color: #FF7FAA;
	background-color: #994900;
}
.b_orange {
	color: #FF7F00;
}
.a_yellow:hover{
	color: #FFFFAA;
	background-color: #999900;
}
.b_yellow {
	color: #FFFF00;
}
.a_green:hover{
	color: #AAFFAA;
	background-color: #009900;
}
.b_green {
	color: #00FF00;
}
.a_aqua:hover{
	color: #AAFFFF;
	background-color: #009999;
}
.b_aqua {
	color: #00FFFF;
}
.a_blue:hover{
	color: #AAAAFF;
	background-color: #000099;
}
.b_blue {
	color: #0000FF;
}
.a_purple:hover{
	color: #FFAAFF;
	background-color: #990099;
}
.b_purple {
	color: #FF00FF;
}
</style>
<script src="table.js"></script>
<script>
var init_shift = 11;
function get_day(){
	d = Math.floor((new Date()) / (1000*60*60*24));
	return (init_shift + d) % 14;
}
var theme = {a:"a_green",b:"b_green"};
function get_theme(d){
	switch(d){
		case 0: case 13: return {a:"a_red",b:"b_red"};
		case 1: case 12: return {a:"a_orange",b:"b_orange"};
		case 2: case 11: return {a:"a_yellow",b:"b_yellow"};
		case 3: case 10: return {a:"a_green",b:"b_green"};
		case 4: case 9: return {a:"a_aqua",b:"b_aqua"};
		case 5: case 8: return {a:"a_blue",b:"b_blue"};
		case 6: case 7: return {a:"a_purple",b:"b_purple"};
	}
	return theme;
}
theme = get_theme(get_day());
var last = [];
list_of_last_volume = 5;
show_duration = -1;
function form_time(v){
	var val = (v-0.0) / 1000.0;
	var uni = "s";
	if(val >= 60.0){ val /= 60.0; uni = "m";}
	else return Math.round(val)+uni;
	if(val >= 60.0){ val /= 60.0; uni = "h";}
	else return Math.round(val)+uni;
	if(val >= 24.0){ val /= 24.0; uni = "d";}
	else return Math.round(val)+uni;
	return Math.round(val)+uni;
}
function run(){
	var now = new Date()
	if(tasks[0].creation_date == 0){
		tasks[0].creation_date = now;
	}
	var i = tasks[0].sessions.length;
	tasks[0].sessions[i] = new Object();
	tasks[0].sessions[i].begin = now;
	tasks[0].sessions[i].end = 0;
	tasks[0].sessions[i].duration = 0;
}
function create_subtask(n,r,t){
	var id = tasks.length;
	tasks[id] = new Object();
	tasks[id].name = n;
	tasks[id].reason = r;
	tasks[id].type=t;
	tasks[id].creation_date = new Date();
	tasks[id].parent_id = current_task;
	tasks[id].id = id;
	tasks[id].time_spended = 0;
	tasks[id].sessions = [];
	tasks[id].subtasks = [];

	var i = tasks[current_task].subtasks.length;
	tasks[current_task].subtasks[i] = id;
}
function switch_to_subtask(s_id){
	var m = 0;
	for(var i =0 ; i < tasks[current_task].subtasks.length; i++){
		if(tasks[current_task].subtasks[i] == s_id){
			m = 1;
			break;
		}
	}
	if(m == 0) alert("sub !");
	else{
		current_task = s_id;
		var i = tasks[current_task].sessions.length;
		tasks[current_task].sessions[i] = new Object();
		tasks[current_task].sessions[i].begin = new Date();
		tasks[current_task].sessions[i].end = 0;
		tasks[current_task].sessions[i].duration = 0;
		tree.array[tree.count] = s_id;
		tree.count++;
	}
	var l = last.length;
	if(l == 0){last[0] = s_id; return;}
	for(var i = 0; i < l; i++){ if(last[i] == s_id) return; }
	if(last[l - 1] == tasks[s_id].parent_id){ last[l - 1] = s_id; return;}

	if(l >= list_of_last_volume){
		for(var i = 0; i <= list_of_last_volume - 2; i++){
			last[i] = last[i - (list_of_last_volume - 2) +  l - 1]
		}
		l = list_of_last_volume - 1;
		last[l] = s_id;
	}else{
	 last[l] = s_id;	
	}

}
function switch_to_task(id){
	if(id == current_task) return;
	finish_tasks();
	var r_tree = [];
	var m = 0;
	for(var i =0 ; i < tasks.length; i++){
		if(tasks[i].id == id){
			m = 1;
			break;
		}
	}
	if(m == 0) alert("task !");
	else{
		r_tree[0] = i;
		var c = i;
		do{
			if(tasks[c].parent_id > 0){
				r_tree[r_tree.length] = tasks[c].parent_id;
			}
			c = tasks[c].parent_id;
		}while(c > 0);
		for(j = r_tree.length-1; j >= 0; j--){
			switch_to_subtask(r_tree[j]);
		}
	}
}

function close_subtask_and_remind(t){
	var s_id = current_task;
	var comm = "alert('Resume the task: " + tasks[s_id].name + "'); switch_to_task(" + s_id + "); reload();";
	setTimeout(comm,t);
	close_subtask();
}
function close_subtask(r){
	var i = tasks[current_task].sessions.length - 1;
	if(tree.count <= 1){
		return -1;
	}
	tasks[current_task].sessions[i].end = new Date();
	var session_time = tasks[current_task].sessions[i].end - tasks[current_task].sessions[i].begin;
	tasks[current_task].sessions[i].duration = session_time;
	tasks[current_task].time_spended += session_time;
	tree.count--;
	current_task = tree.array[tree.count - 1];
	return 0;
}
function finish_tasks(){
	var r = -1;
	do{
		r = close_subtask("");
	}while(r != -1);
	var i = tasks[0].sessions.length - 1;
	tasks[0].sessions[i].end = new Date();
	var d = tasks[0].sessions[i].end - tasks[0].sessions[i].begin;
	tasks[0].sessions[i].duration = d;
	tasks[0].time_spended += d;
}
function save_table(){
	var text = "var current_task=0;var tree=new Object({count:1,array:[0]});var tasks="
		 + JSON.stringify(tasks) + ";var book=" + JSON.stringify(book) + ";";
	blob = new Blob([text], { type: 'text/plain' }),
	anchor = document.createElement('a');

	anchor.download = "table.js";
	anchor.href = (window.webkitURL || window.URL).createObjectURL(blob);
	anchor.dataset.downloadurl = ['text/plain', anchor.download, anchor.href].join(':');
	anchor.click();
	document.getElementsByTagName('body')[0].innerHTML = text;
}

function create_new_subtask(){
	name = document.getElementById('s_name').value;
	create_subtask(name,"reason","type");
}
/*
Bookmark
*/
function bookmark(){
	book.list[book.len] = current_task;
	book.len++;
}
function show_book(){
	var t = "";
	for(var i = 0; i < book.len; i++){
 		t += "<div class=\"" + theme.a +" " + theme.b +"\" id=task" + book.list[i] + " onclick=\"switch_to_task(" + book.list[i] + "); reload();\">" + formatHTML(tasks[book.list[i]].name) + "</div>";
	}
	t += "<div\">Click on task to run it</div>"
	document.getElementById('bookmarks').innerHTML = t;
}

/*

	Dislpay on HTML functions

*/
function formatHTML(a){
	var A = a;
	while (A.indexOf(">") != -1){
		A = A.replace(">", "&gt;");
	}
	while (A.indexOf("<") != -1){
		A = A.replace("<", "&lt;");
	}
	return A;
}

function show_tree(){
	var t = "";
	var id = 0;
	t += "<div class=" + theme.a +" onclick=\"bookmark(); reload();\">Click to bookmark</div>";
	for(var i = 0; i < tree.count; i++){
		id = tree.array[i];
 		t += "<div class=" + theme.b +" id=task" + id + ">" + formatHTML(tasks[id].name) + "</div>";
	}
	t += "<div class=" + theme.a +" onclick=\"create_new_subtask(); reload();\">Click to add subtask</div>";
	t += "<input type = text id=s_name>";
	document.getElementById('tree').innerHTML = t;
}
function show_subtasks(){
	var t = "";
	var id = 0;
	var o = tasks[current_task].subtasks;
	for(var i = 0; i < o.length; i++){
		id = o[i];
 		t += "<div class=\"" + theme.a +" " + theme.b +"\" id=task" + id + " onclick=\"switch_to_subtask(" + id + "); reload();\">" + formatHTML(tasks[id].name) + ((show_duration==1)?("["+form_time(tasks[id].time_spended)+"]"):"") + "</div>";
	}
	t += "<div\">Click on subtask to run it</div>"
	document.getElementById('subtasks').innerHTML = t;
}
function show_table(){
	var t = "";
	for(var i = 0; i < tasks.length; i++){
 		t += "<div class=\"" + theme.a +" " + theme.b +"\" id=task" + i + " onclick=\"switch_to_task(" + i + "); reload();\">" + formatHTML(tasks[i].name) + "</div>";
	}
	t += "<div\">Click on task to run it</div>"
	document.getElementById('table').innerHTML = t;
}
function show_latest(){
	var t = "";
	for(var i = 0; i < last.length; i++){
 		t += "<div class=\"" + theme.a +" " + theme.b +"\" id=task" + last[i] + " onclick=\"switch_to_task(" + last[i] + "); reload();\">" + formatHTML(tasks[last[i]].name) + "</div>";
	}
	t += "<div\">Click on task to run it</div>"
	document.getElementById('latest').innerHTML = t;
}
function show_finish(){
	var t = "";
	t += "<div class=" + theme.a +" onclick=\"finish_tasks();save_table();\">Click to end all tasks and close tab</div>";
	document.getElementById('finish').innerHTML = t;
}
function show_current(){
	var pp = [5,15,30,60];
	var t = "";
	t += "<div class=" + theme.a +" onclick=\"close_subtask();reload();\">Click to close subtask</div>";
	for(var i = 0; i < pp.length; i++){
		t += "<div class=" + theme.a +" onclick=\"close_subtask_and_remind(" + pp[i] + "*60*1000);reload();\">Click to close subtask and remind after ";
		if(pp[i] < 60) t += pp[i] + " min</div>";
		else if(pp[i] == 60) t += "1 hour</div>";
	}
	document.getElementById('current').innerHTML = t;
}
function reload(){
	show_book();
	show_latest();
	show_tree();
	show_subtasks();
	show_table();
	show_finish();
	show_current();
}
</script>
</head>
<body>
<div onclick="show_duration*=-1; reload();">time</div>
<h1>Finish</h1><div id=finish></div>
<h1>Bookmarks</h1><div id=bookmarks></div>
<h1>Latest</h1><div id=latest></div>
<h1>Tree</h1><div id=tree></div>
<h1>Current Task</h1><div id=current></div>
<h1>Subtasks</h1><div id=subtasks></div>
<h1>All the tasks</h1><div id=table></div>
<script>
run();
reload();
</script>
</body>
</html>